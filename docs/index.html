<!DOCTYPE html>
<!--
    DP // Dual Processing Guitar FX
    Production-Ready Web Interface with Firmware Flasher
    Repository: https://github.com/willbearfruits/daisy-guitar-web
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="DP Dual Processing - Professional dual-channel guitar effects processor for Daisy Seed">
    <meta name="keywords" content="Daisy Seed, guitar effects, dual processing, Web Serial API, audio processing">
    <title>DP // Dual Processing</title>
    <!-- Tailwind CDN: For development/GitHub Pages. For production builds, use: npm install tailwindcss -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        /* Animations */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(45, 212, 191, 0.3); }
            50% { box-shadow: 0 0 20px rgba(45, 212, 191, 0.6); }
        }
        .status-pulse { animation: pulse-glow 2s ease-in-out infinite; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in { animation: slideIn 0.3s ease-out; }

        /* Custom range slider */
        input[type=range]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: #14b8a6;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #0d9488;
        }
        input[type=range] {
            appearance: none;
            background: #374151;
            height: 6px;
            border-radius: 3px;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        .toast.success { border-left: 4px solid #14b8a6; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.warning { border-left: 4px solid #f59e0b; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans overflow-hidden">

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <div class="flex h-screen">

        <!-- Sidebar -->
        <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col p-4">
            <div class="flex items-center gap-3 px-2 mb-8 mt-2">
                <div class="w-10 h-10 bg-gradient-to-br from-teal-500 to-teal-600 rounded-lg flex items-center justify-center shadow-lg shadow-teal-500/20">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                    </svg>
                </div>
                <div>
                    <div class="font-bold text-xl tracking-tight">DP</div>
                    <div class="text-xs text-gray-500">Dual Processing</div>
                </div>
            </div>

            <nav class="space-y-1 flex-1">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 bg-gray-800 text-teal-400 font-medium">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                    </svg>
                    Dashboard
                </button>
                <button onclick="switchView('firmware')" id="nav-firmware" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 text-gray-400 hover:bg-gray-800 hover:text-gray-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    Firmware
                </button>
            </nav>

            <!-- Connection Status -->
            <div class="border-t border-gray-800 pt-4 mt-4">
                <div id="connectionStatus" class="flex items-center gap-2 px-2 py-2 rounded-lg bg-gray-800/50">
                    <div id="statusDot" class="w-2 h-2 rounded-full bg-gray-600"></div>
                    <span id="statusText" class="text-xs text-gray-500">Disconnected</span>
                </div>
                <button id="connectBtn" onclick="handleConnect()" class="w-full mt-2 bg-teal-500 hover:bg-teal-600 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                    CONNECT
                </button>
            </div>

            <div class="text-xs text-gray-600 px-2 mt-4">
                v2.0.0 Production
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-hidden flex flex-col">
            <!-- Header -->
            <header class="h-16 border-b border-gray-800 bg-gray-900 flex items-center justify-between px-8">
                <h1 id="pageTitle" class="text-2xl font-bold text-white tracking-tight">Dashboard</h1>
                <div class="flex items-center gap-4">
                    <a href="https://github.com/willbearfruits/daisy-guitar-web" target="_blank" class="text-gray-400 hover:text-white transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                        </svg>
                    </a>
                </div>
            </header>

            <!-- Content Body -->
            <div class="flex-1 overflow-y-auto p-8">
                <!-- Dashboard View -->
                <div id="dashboardView" class="max-w-7xl mx-auto">
                    <!-- Dual Channel Layout -->
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <!-- Channel 1 -->
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 border-l-4 border-l-teal-500">
                            <h2 class="text-xl font-bold text-teal-400 mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Channel 1
                            </h2>
                            <div id="ch1-controls" class="space-y-4"></div>
                        </div>

                        <!-- Channel 2 -->
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 border-l-4 border-l-pink-500">
                            <h2 class="text-xl font-bold text-pink-400 mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Channel 2
                            </h2>
                            <div id="ch2-controls" class="space-y-4"></div>
                        </div>
                    </div>

                    <!-- Master Controls -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h2 class="text-xl font-bold text-white mb-4">Master & Cross-Channel</h2>
                        <div id="master-controls" class="grid grid-cols-3 gap-6"></div>
                    </div>
                </div>

                <!-- Firmware View -->
                <div id="firmwareView" class="hidden max-w-4xl mx-auto">
                    <div class="bg-gray-800 rounded-xl p-8 border border-gray-700">
                        <h2 class="text-2xl font-bold text-white mb-6">Firmware Management</h2>

                        <!-- Browser Compatibility Warning -->
                        <div id="compatibility-warning" class="hidden mb-6 bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                            <h4 class="text-red-400 font-semibold mb-2">‚ö†Ô∏è Browser Not Supported</h4>
                            <p class="text-sm text-gray-300">WebUSB is not supported in this browser. Please use Chrome, Edge, or Opera.</p>
                        </div>

                        <!-- Web Flasher Section -->
                        <div class="mb-8 bg-gray-900/50 rounded-lg p-6 border border-gray-700">
                            <h3 class="text-lg font-semibold text-teal-400 mb-4">‚ö° Web Flasher</h3>

                            <!-- Bootloader Instructions -->
                            <div class="mb-4 bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                                <p class="text-sm text-gray-300">
                                    <strong class="text-blue-400">Step 1:</strong> Put Daisy in DFU bootloader mode: Hold <kbd class="px-2 py-1 bg-gray-700 rounded">BOOT</kbd>, press <kbd class="px-2 py-1 bg-gray-700 rounded">RESET</kbd>, release both
                                </p>
                            </div>

                            <!-- Status Display -->
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                                    <div class="text-xs text-gray-500 mb-1">Device Status</div>
                                    <div id="device-status" class="text-sm font-semibold text-gray-400">Not Connected</div>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                                    <div class="text-xs text-gray-500 mb-1">Firmware Status</div>
                                    <div id="firmware-status" class="text-sm font-semibold text-gray-400">Not Loaded</div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <button id="connect-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    Connect to Daisy Seed
                                </button>
                                <button id="flash-btn" disabled class="bg-pink-500 hover:bg-pink-600 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    Flash Firmware
                                </button>
                            </div>

                            <!-- Progress Bar -->
                            <div id="progress-container" class="hidden mb-6">
                                <div class="w-full bg-gray-700 rounded-full h-6 overflow-hidden">
                                    <div id="progress-fill" class="h-full bg-gradient-to-r from-teal-500 to-pink-500 transition-all duration-300 flex items-center justify-center" style="width: 0%">
                                        <span id="progress-text" class="text-xs font-semibold text-white">0%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Custom Firmware Upload -->
                            <details class="mb-4">
                                <summary class="cursor-pointer text-sm text-gray-400 hover:text-teal-400 transition-colors">
                                    Upload Custom Firmware (.bin)
                                </summary>
                                <div class="mt-3 bg-gray-800 p-4 rounded-lg border border-gray-700">
                                    <input type="file" id="custom-firmware" accept=".bin" class="hidden">
                                    <label for="custom-firmware" class="block w-full text-center bg-gray-700 hover:bg-gray-600 text-gray-300 py-2 px-4 rounded cursor-pointer transition-colors">
                                        Choose .bin file
                                    </label>
                                    <div id="custom-filename" class="mt-2 text-xs text-gray-500 text-center">No file selected</div>
                                </div>
                            </details>

                            <!-- Activity Log -->
                            <div>
                                <h4 class="text-sm font-semibold text-gray-400 mb-2">Activity Log</h4>
                                <div id="log-output" class="bg-gray-800 rounded-lg p-4 border border-gray-700 h-48 overflow-y-auto font-mono text-xs space-y-1"></div>
                            </div>
                        </div>

                        <!-- CLI Instructions (Collapsible) -->
                        <details class="bg-gray-900/50 rounded-lg border border-gray-700">
                            <summary class="cursor-pointer p-6 text-lg font-semibold text-teal-400 hover:text-teal-300 transition-colors">
                                üíª Advanced: Command Line Interface
                            </summary>
                            <div class="p-6 pt-0 space-y-6">
                                <!-- Flash Instructions -->
                                <div>
                                    <h3 class="text-md font-semibold text-teal-400 mb-3">Flashing Instructions</h3>
                                    <ol class="space-y-3 text-gray-300">
                                        <li class="flex gap-3">
                                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-teal-500 text-white text-sm flex items-center justify-center font-bold">1</span>
                                            <span>Build the firmware: <code class="bg-gray-800 px-2 py-1 rounded text-teal-400">cd firmware && make</code></span>
                                        </li>
                                        <li class="flex gap-3">
                                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-teal-500 text-white text-sm flex items-center justify-center font-bold">2</span>
                                            <span>Put Daisy in DFU mode: Hold <kbd class="px-2 py-1 bg-gray-700 rounded">BOOT</kbd>, press <kbd class="px-2 py-1 bg-gray-700 rounded">RESET</kbd>, release both</span>
                                        </li>
                                        <li class="flex gap-3">
                                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-teal-500 text-white text-sm flex items-center justify-center font-bold">3</span>
                                            <span>Flash: <code class="bg-gray-800 px-2 py-1 rounded text-teal-400">make program-dfu</code></span>
                                        </li>
                                        <li class="flex gap-3">
                                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-teal-500 text-white text-sm flex items-center justify-center font-bold">4</span>
                                            <span>Reset Daisy and connect via Dashboard tab</span>
                                        </li>
                                    </ol>
                                </div>

                                <!-- Build Commands -->
                                <div>
                                    <h3 class="text-md font-semibold text-teal-400 mb-3">Build Commands</h3>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded">
                                            <code class="text-gray-300">make clean</code>
                                            <span class="text-xs text-gray-500">Clean build artifacts</span>
                                        </div>
                                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded">
                                            <code class="text-gray-300">make</code>
                                            <span class="text-xs text-gray-500">Build firmware</span>
                                        </div>
                                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded">
                                            <code class="text-gray-300">make program-dfu</code>
                                            <span class="text-xs text-gray-500">Flash via DFU</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Requirements -->
                                <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                                    <h4 class="text-yellow-400 font-semibold mb-2">Requirements</h4>
                                    <ul class="text-sm text-gray-300 space-y-1">
                                        <li>‚Ä¢ ARM GCC Toolchain installed</li>
                                        <li>‚Ä¢ libDaisy and DaisySP libraries at <code class="bg-gray-800 px-1 rounded">~/DaisyExamples/</code></li>
                                        <li>‚Ä¢ dfu-util installed for flashing</li>
                                    </ul>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { DaisyBridge } from './daisy-bridge.js?v=2.0';

        const daisy = new DaisyBridge();
        let currentView = 'dashboard';

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type} slide-in`;
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="text-${type === 'success' ? 'teal' : type === 'error' ? 'red' : 'yellow'}-400">
                        ${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚ö†'}
                    </div>
                    <div class="text-sm">${message}</div>
                </div>
            `;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // View switching
        window.switchView = function(view) {
            currentView = view;
            document.getElementById('dashboardView').classList.toggle('hidden', view !== 'dashboard');
            document.getElementById('firmwareView').classList.toggle('hidden', view !== 'firmware');
            document.getElementById('pageTitle').textContent = view === 'dashboard' ? 'Dashboard' : 'Firmware';

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-gray-800', 'text-teal-400', 'font-medium');
                btn.classList.add('text-gray-400');
            });
            document.getElementById(`nav-${view}`).classList.remove('text-gray-400');
            document.getElementById(`nav-${view}`).classList.add('bg-gray-800', 'text-teal-400', 'font-medium');
        };

        // Connection handling
        window.handleConnect = async function() {
            const btn = document.getElementById('connectBtn');
            btn.disabled = true;
            btn.textContent = 'CONNECTING...';

            const success = await daisy.connect();

            if (!success) {
                btn.disabled = false;
                btn.textContent = 'RETRY CONNECTION';
            }
        };

        // Event listeners for connection status
        window.addEventListener('daisy-connected', () => {
            document.getElementById('statusDot').className = 'w-2 h-2 rounded-full bg-teal-500 status-pulse';
            document.getElementById('statusText').textContent = 'Connected';
            document.getElementById('statusText').className = 'text-xs text-teal-400';
            document.getElementById('connectBtn').textContent = 'CONNECTED';
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('connectBtn').className = 'w-full mt-2 bg-teal-500 text-white font-medium py-2 px-4 rounded-lg cursor-not-allowed opacity-75';
            showToast('Successfully connected to Daisy Seed', 'success');
        });

        window.addEventListener('daisy-disconnected', () => {
            document.getElementById('statusDot').className = 'w-2 h-2 rounded-full bg-gray-600';
            document.getElementById('statusText').textContent = 'Disconnected';
            document.getElementById('statusText').className = 'text-xs text-gray-500';
            document.getElementById('connectBtn').textContent = 'CONNECT';
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('connectBtn').className = 'w-full mt-2 bg-teal-500 hover:bg-teal-600 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200';
            showToast('Disconnected from Daisy', 'warning');
        });

        window.addEventListener('daisy-reconnecting', (e) => {
            document.getElementById('statusDot').className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
            document.getElementById('statusText').textContent = `Reconnecting (${e.detail.attempt}/3)...`;
            document.getElementById('statusText').className = 'text-xs text-yellow-400';
            showToast(`Reconnecting... Attempt ${e.detail.attempt}`, 'warning');
        });

        window.addEventListener('daisy-reconnected', () => {
            showToast('Reconnected successfully!', 'success');
        });

        window.addEventListener('daisy-error', (e) => {
            if (e.detail.critical) {
                showToast(e.detail.message, 'error');
            }
        });

        // Parameter definitions
        const channelParams = [
            { id: 'gain', name: 'Input Gain', min: 0, max: 2, step: 0.01, default: 1.0 },
            { id: 'drive', name: 'Overdrive', min: 0, max: 1, step: 0.01, default: 0.0 },
            { id: 'filter_mode', name: 'Filter Mode', type: 'select', options: [{v:0,n:'Lowpass'},{v:1,n:'Bandpass'},{v:2,n:'Highpass'}], default: 0 },
            { id: 'filter_freq', name: 'Filter Cutoff', min: 20, max: 20000, step: 10, default: 10000, unit: 'Hz' },
            { id: 'filter_res', name: 'Resonance', min: 0, max: 1, step: 0.01, default: 0.1 },
            { id: 'delay_time', name: 'Delay Time', min: 0, max: 1, step: 0.01, default: 0.0, unit: 's' },
            { id: 'delay_fb', name: 'Delay Feedback', min: 0, max: 0.95, step: 0.01, default: 0.0 },
            { id: 'delay_mix', name: 'Delay Mix', min: 0, max: 1, step: 0.01, default: 0.0 },
            { id: 'chorus_depth', name: 'Chorus Depth', min: 0, max: 1, step: 0.01, default: 0.0 },
            { id: 'chorus_rate', name: 'Chorus Rate', min: 0.01, max: 10, step: 0.1, default: 0.5, unit: 'Hz' }
        ];

        const masterParams = [
            { id: 'cross_mod', name: 'Cross Modulation', min: 0, max: 1, step: 0.01, default: 0.0 },
            { id: 'cross_bleed', name: 'Channel Bleed', min: 0, max: 1, step: 0.01, default: 0.0 },
            { id: 'stereo_width', name: 'Stereo Width', min: 0, max: 2, step: 0.01, default: 1.0 },
            { id: 'reverb_time', name: 'Reverb Time', min: 0, max: 1, step: 0.01, default: 0.5 },
            { id: 'reverb_mix', name: 'Reverb Mix', min: 0, max: 1, step: 0.01, default: 0.0 },
            { id: 'master_gain', name: 'Master Gain', min: 0, max: 2, step: 0.01, default: 1.0 }
        ];

        // Create controls
        function createControl(param, prefix) {
            const paramName = prefix ? `${prefix}_${param.id}` : param.id;

            if (param.type === 'select') {
                const html = `
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-300">${param.name}</label>
                        <select id="${paramName}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-teal-500 focus:outline-none">
                            ${param.options.map(opt => `<option value="${opt.v}">${opt.n}</option>`).join('')}
                        </select>
                    </div>
                `;
                return html;
            } else {
                const html = `
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="text-sm font-medium text-gray-300">${param.name}</label>
                            <span id="${paramName}-val" class="text-sm font-mono text-teal-400">${param.default}${param.unit || ''}</span>
                        </div>
                        <input
                            type="range"
                            id="${paramName}"
                            min="${param.min}"
                            max="${param.max}"
                            step="${param.step}"
                            value="${param.default}"
                            class="w-full cursor-pointer"
                        >
                    </div>
                `;
                return html;
            }
        }

        // Render controls
        document.getElementById('ch1-controls').innerHTML = channelParams.map(p => createControl(p, 'ch1')).join('');
        document.getElementById('ch2-controls').innerHTML = channelParams.map(p => createControl(p, 'ch2')).join('');
        document.getElementById('master-controls').innerHTML = masterParams.map(p => createControl(p, null)).join('');

        // Attach event listeners
        [...document.querySelectorAll('input[type="range"], select')].forEach(el => {
            const updateFn = async () => {
                const value = parseFloat(el.value);
                const param = el.id;
                const valDisplay = document.getElementById(`${param}-val`);

                if (valDisplay) {
                    const paramDef = [...channelParams, ...masterParams].find(p =>
                        param.endsWith(p.id) || param === p.id
                    );
                    const unit = paramDef?.unit || '';
                    const displayVal = paramDef?.id === 'filter_freq' ? Math.round(value) : value.toFixed(2);
                    valDisplay.textContent = displayVal + unit;
                }

                if (daisy.isConnected) {
                    await daisy.sendParam(param, value);
                }
            };

            el.addEventListener('input', updateFn);
            el.addEventListener('change', updateFn);
        });

        console.log('DP v2.0 - Production Ready');
    </script>

    <!-- Web Flasher Module -->
    <script type="module" src="./flasher.js"></script>

    <!-- Add CSS for log entries -->
    <style>
        .log-entry { padding: 2px 0; }
        .log-entry.info { color: #9ca3af; }
        .log-entry.success { color: #14b8a6; }
        .log-entry.warning { color: #f59e0b; }
        .log-entry.error { color: #ef4444; }
        :root {
            --success-color: #14b8a6;
            --danger-color: #ef4444;
            --text-muted: #9ca3af;
        }
    </style>
</body>
</html>
